class App extends HTMLElement{static{customElements.define("st-app",this)}static boolean_attributes=new Set(["disabled","checked","readonly","required","selected","hidden","open","autofocus"]);static#e=new Map;static#t=new Set;static create(e){let{app:t,setup:i=()=>{},template:s="",events:r={}}=e;if(App.#e.has(t))throw new Error(`Application "${t}" already exists!`);App.#e.set(t,{setup:i,template:s,events:r,config:e}),App.#t.forEach(e=>{!0!==e.#i&&e.#s()})}#i=!1;#r="";#n=!1;#l=new Map;#o=null;#a=new Set;#h=!1;#c=[];#u=null;#d=new Map;#p=null;#f=[];#b=new Set;#m=!1;#g=new Map;constructor(){super(),App.#t.add(this)}#y(e){e&&e.length&&e.forEach(e=>{if("event"===e.type&&e.element&&e.handler)e.element.removeEventListener(e.eventName,e.handler);else if("model"===e.type&&e.element&&e.handler){let t="SELECT"===e.element.tagName?"change":"input";e.element.removeEventListener(t,e.handler)}else"attrSync"===e.type&&e.unwatch&&e.unwatch();e.effect&&(this.#l.forEach((t,i)=>{t.delete(e.effect),0===t.size&&this.#l.delete(i)}),this.#a.delete(e.effect))})}get attrs(){return{get:e=>this.getAttribute(e),set:(e,t)=>this.setAttribute(e,t),remove:e=>this.removeAttribute(e),has:e=>this.hasAttribute(e),toggle:(e,t)=>this.toggleAttribute(e,t),keys:()=>Array.from(this.attributes).map(e=>e.name),entries:()=>Array.from(this.attributes).map(e=>[e.name,e.value])}}dispatch(e,t,i={}){let s=new CustomEvent(e,{cancelable:!0,...i,detail:t});return this.dispatchEvent(s),s}watch(e,t,i={}){if("function"!=typeof t)return()=>{};let{deep:s=!1,immediate:r=!1}=i;if("string"==typeof e&&e.endsWith("()")){let i=e.slice(0,-2),s=this[i];if("function"!=typeof s)return()=>{};let r=this.#g.get(i);if(!r){r={original:s,handlers:[]},this.#g.set(i,r);let e=(...e)=>{let t=s.apply(this,e),i=t=>{for(let i of[...r.handlers])i.callback(e,t,i.unwatch)};return t instanceof Promise?t.then(e=>(i(e),e)):(i(t),t)};this[i]=e}let n=()=>{let e=r.handlers.findIndex(e=>e.unwatch===n);-1!==e&&r.handlers.splice(e,1),0===r.handlers.length&&(this[i]=r.original,this.#g.delete(i))};return r.handlers.push({callback:t,unwatch:n}),n}if("string"==typeof e){let i=e,n=()=>{let e=this.#f.findIndex(e=>e.unwatch===n);-1!==e&&this.#f.splice(e,1)},l={type:"key",key:i,callback:t,deep:s,immediate:r,lastValue:void 0,unwatch:n};if(this.#f.push(l),r){let e=this.#v(i);l.lastValue=s&&null!==e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):e,t(e,void 0,n)}return n}if("function"==typeof e){let i,r=e,n={type:"getter",getter:r,callback:t,deep:s,lastValue:i,effect:null,unwatch:null};this.#f.push(n);let l=()=>{let e=this.#f.indexOf(n);-1!==e&&this.#f.splice(e,1),n.effect&&(this.#l.forEach((e,t)=>{e.delete(n.effect),0===e.size&&this.#l.delete(t)}),this.#a.delete(n.effect))};n.unwatch=l;let o=()=>{let e=r.call(this);if(s?!this.#x(e,i):e!==i){let r=i;i=s&&null!==e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):e,t(e,r,n.unwatch)}},a=this.#E(o);return n.effect=a,l}return()=>{}}#A(e){this.#o&&(this.#l.has(e)||this.#l.set(e,new Set),this.#l.get(e).add(this.#o))}#w(e){this.#b.add(e);let t=this.#l.get(e);if(t&&t.forEach(e=>this.#a.add(e)),this.#h)return void(this.#m=!0);this.#h=!0;const i=()=>{this.#a.forEach(e=>{try{e()}catch(e){console.error("Effect execution error:",e)}}),this.#a.clear();let e=Array.from(this.#b),t=new Set;for(let i of e)for(let e of this.#f){if("key"!==e.type)continue;(e.key===i||e.deep&&(i===e.key||i.startsWith(e.key+".")))&&t.add(e)}for(let e of t){if("key"!==e.type)continue;let t=this.#v(e.key);if(!(e.deep?!this.#x(t,e.lastValue):t!==e.lastValue))continue;let i=e.lastValue;e.lastValue=e.deep&&null!==t&&"object"==typeof t?JSON.parse(JSON.stringify(t)):t,e.callback(t,i,e.unwatch)}this.#b.clear(),this.#h=!1,this.#m&&(this.#m=!1,this.#h=!0,Promise.resolve().then(i))};Promise.resolve().then(i)}#v(e){return e.split(".").reduce((e,t)=>e?.[t],this)}#x(e,t){if(Object.is(e,t))return!0;if(null===e||null===t||"object"!=typeof e||"object"!=typeof t)return!1;let i=Object.keys(e),s=Object.keys(t);if(i.length!==s.length)return!1;for(let r of i)if(!s.includes(r)||!this.#x(e[r],t[r]))return!1;return!0}#N(e,t=[]){if(null===e||"object"!=typeof e||e.__isReactive)return e;let i=this;return new Proxy(e,{get(e,s,r){if("__isReactive"===s)return!0;const n="symbol"==typeof s?"<symbol>":s;let l=[...t,n].join(".");i.#A(l);let o=Reflect.get(e,s,r);return null===o||"object"!=typeof o||o.__isReactive?o:i.#N(o,[...t,n])},set(e,s,r,n){if(e[s]===r)return!0;let l=Reflect.set(e,s,r,n);const o="symbol"==typeof s?"<symbol>":s;let a=[...t,o].join(".");if(i.#w(a),Array.isArray(e)&&("length"===s||!isNaN(s))){let e=t.join(".");e&&i.#w(e)}return l},deleteProperty(e,s){let r=Reflect.deleteProperty(e,s);const n="symbol"==typeof s?"<symbol>":s;let l=[...t,n].join(".");return i.#w(l),r}})}#k(e,t){let i=this;return new Proxy(e,{apply(e,s,r){let n=Reflect.apply(e,i,r);return n instanceof Promise?n.then(e=>(i.#w(t),e)):(i.#w(t),n)}})}#E(e){let t=this.#u?{...this.#u}:null,i=()=>{let s=null;if(t){s={};for(let e of Object.keys(t))s[e]=this[e],this[e]=t[e]}this.#o=i;try{e()}finally{if(this.#o=null,s)for(let e of Object.keys(s))void 0!==s[e]?this[e]=s[e]:delete this[e]}};return i(),i}#O(e){try{return new Function("$event",`with(this) { return (${e}); }`).call(this)}catch(t){return void console.warn("Expression evaluation error:",e,t)}}#S(e,t=null){try{return new Function("$event",`with(this) { ${e} }`).call(this,t)}catch(t){console.error("Statement execution error:",e,t)}}#j(e){let t,i=e.nodeValue,s=[],r=[],n=0,l=/\{\{(.+?)\}\}/g;for(;null!==(t=l.exec(i));){t.index>n&&s.push(i.substring(n,t.index));let e=t[1].trim();s.push(null),r.push({index:s.length-1,expr:e}),n=l.lastIndex}n<i.length&&s.push(i.substring(n));let o=this.#E(()=>{r.forEach(({index:e,expr:t})=>{let i=this.#O(t);s[e]=null==i?"":String(i)}),e.nodeValue=s.join("")});this.#c.push({type:"text",node:e,effect:o})}#P(e,t){let i=t.name.slice(1),s=t.value,r=this.#u?{...this.#u}:null,n=e=>{if(r){let t={};for(let e of Object.keys(r))t[e]=this[e],this[e]=r[e];this.#S(s,e);for(let e of Object.keys(t))void 0!==t[e]?this[e]=t[e]:delete this[e]}else this.#S(s,e)};e.addEventListener(i,n),this.#c.push({type:"event",element:e,eventName:i,handler:n})}#C(e,t){let i=t.value,s=this.#E(()=>{let t=this.#O(i);e.style.display=t?"":"none"});this.#c.push({type:"show",element:e,effect:s})}#T(e,t){let i=t.value,s=this.#E(()=>{let t=this.#O(i);"INPUT"===e.tagName&&"checkbox"===e.type?e.checked=!!t:"INPUT"===e.tagName&&"radio"===e.type?e.checked=e.value===t:"SELECT"===e.tagName?e.value=t:e.value=null==t?"":t}),r=this.#u?{...this.#u}:null,n="SELECT"===e.tagName?"change":"input",l=t=>{let s;if(s="checkbox"===e.type?e.checked:"number"===e.type?e.valueAsNumber:e.value,r){let e={};for(let t of Object.keys(r))e[t]=this[t],this[t]=r[t];try{new Function("value",`with(this) { ${i} = value; }`).call(this,s)}catch(t){console.error("Model binding error:",i,t)}for(let t of Object.keys(e))void 0!==e[t]?this[t]=e[t]:delete this[t]}else try{new Function("value",`with(this) { ${i} = value; }`).call(this,s)}catch(t){console.error("Model binding error:",i,t)}};e.addEventListener(n,l),this.#c.push({type:"model",element:e,effect:s,handler:l})}#L(e,t){let i=t.value,s=document.createComment(`if: ${i}`);e.parentNode.insertBefore(s,e);let r=[{expr:i,element:e,bindings:[],processed:!1}],n=e.nextElementSibling;for(;n;){if(!n.hasAttribute("#else-if")){if(n.hasAttribute("#else")){r.push({expr:"true",element:n,bindings:[],processed:!1}),n.removeAttribute("#else"),n.remove();break}break}{let e=n.getAttribute("#else-if");r.push({expr:e,element:n,bindings:[],processed:!1}),n.removeAttribute("#else-if");let t=n.nextElementSibling;n.remove(),n=t}}e.remove();let l=null,o=this.#E(()=>{let e=null;for(let t of r){if(this.#O(t.expr)){e=t;break}}if(l!==e){if(l&&(l.element&&l.element.parentNode&&l.element.remove(),this.#y(l.bindings),l.bindings=[]),e&&(s.parentNode.insertBefore(e.element,s.nextSibling),!e.processed)){let t=this.#c.length;this.#$(e.element),e.bindings=this.#c.slice(t),e.processed=!0}l=e}});this.#c.push({type:"conditional",placeholder:s,chain:r,effect:o})}#M(e,t){let i=t.value,s=i.match(/^\s*(\w+)\s+in\s+(.+)$/);if(!s)return void console.error("Invalid for syntax:",i);let r=s[1],n=s[2],l=e.parentNode,o=e.nextSibling;e.removeAttribute(t.name);let a=e.cloneNode(!0);e.remove();let h=[],c=this.#E(()=>{let e,t=this.#O(n);if(h.forEach(e=>{e.node&&e.node.parentNode&&e.node.remove(),this.#y(e.bindings)}),h=[],Array.isArray(t))e=t.map((e,t)=>({value:e,key:void 0,index:t}));else{if(null===t||"object"!=typeof t)return;e=Object.entries(t).map(([e,t],i)=>({value:t,key:e,index:i}))}if(0===e.length)return;let i=document.createDocumentFragment();e.forEach(({value:e,key:t,index:s})=>{let n=a.cloneNode(!0),l=this[r],o=this.$index,c=this.$key;this[r]=e,this.$index=s,void 0!==t&&(this.$key=t);let u=this.#u,d={...u,[r]:e,$index:s};void 0!==t&&(d.$key=t),this.#u=d;let p=this.#c.length;this.#$(n);let f=this.#c.slice(p);this.#u=u,void 0!==l?this[r]=l:delete this[r],void 0!==o?this.$index=o:delete this.$index,void 0!==c?this.$key=c:delete this.$key,i.appendChild(n),h.push({node:n,bindings:f})}),l.insertBefore(i,o)});this.#c.push({type:"loop",parent:l,nextSibling:o,template:a,effect:c})}#F(e,t){let i,s=t.name,r=t.value,n=[],l=[],o=0,a=/\{\{(.+?)\}\}/g;for(;null!==(i=a.exec(r));){i.index>o&&n.push(r.substring(o,i.index));let e=i[1].trim();n.push(null),l.push({index:n.length-1,expr:e}),o=a.lastIndex}o<r.length&&n.push(r.substring(o));let h=this.#E(()=>{l.forEach(({index:e,expr:t})=>{let i=this.#O(t);n[e]=null==i?"":String(i)});let t=n.join("");if(App.boolean_attributes.has(s)){""===t||"false"===t||"0"===t||"null"===t||"undefined"===t||!t?e.removeAttribute(s):e.setAttribute(s,"")}else e.setAttribute(s,t)});this.#c.push({type:"attribute",element:e,attrName:s,effect:h})}#R(e){let t=Array.from(e.attributes);for(let i of t){if("#if"===i.name)return this.#L(e,i),e.removeAttribute(i.name),!0;if("#for"===i.name)return this.#M(e,i),e.removeAttribute(i.name),!0;if("#show"===i.name)this.#C(e,i),e.removeAttribute(i.name);else if("#model"===i.name)this.#T(e,i),e.removeAttribute(i.name);else if("#once"===i.name)e.removeAttribute(i.name);else{if("#pre"===i.name)return e.removeAttribute(i.name),!0;i.name.startsWith("@")?(this.#P(e,i),e.removeAttribute(i.name)):/\{\{.+?\}\}/.test(i.value)&&this.#F(e,i)}}return!1}#$(e){if(e.nodeType===Node.ELEMENT_NODE){let t=this.#R(e);if("st-app"===e.localName)return;!t&&(e.parentNode||e.childNodes.length>0)&&Array.from(e.childNodes).forEach(e=>this.#$(e))}else e.nodeType===Node.TEXT_NODE&&/\{\{.+?\}\}/.test(e.nodeValue)&&this.#j(e)}#s(){let e=this.attrs.get("::app"),t=App.#e.get(e);if(t){this.addEventListener("setup",t.setup),Object.entries(t.events).forEach(([e,t])=>this.addEventListener(e,t)),this.#r=t.template;let e=t.config,i=Object.getOwnPropertyDescriptors(e),s=new Set(["app","setup","template","events"]);Object.entries(i).forEach(([e,t])=>{if(!s.has(e))if(t.get){let i=t.get;this.#d.set(e,i),Object.defineProperty(this,e,{get(){return this.#A(e),i.call(this)},enumerable:t.enumerable,configurable:!0})}else if(void 0!==t.value){let i=t.value,s=i;"object"==typeof i&&null!==i?s=this.#N(i,[e]):"function"==typeof i&&(s=this.#k(i,e)),Object.defineProperty(this,e,{get(){return this.#A(e),s},set(t){s!==t&&(s="object"==typeof t&&null!==t?this.#N(t,[e]):t,this.#w(e))},enumerable:!0,configurable:!0})}}),!1!==this.#i&&this.#i(),this.#i=!0}else this.attrs.get("::app")||("function"==typeof this.#i&&this.#i(),this.#i=!0)}async#V(e){await Promise.all(e.map(e=>new Promise(t=>{let i=null,s=()=>{clearTimeout(i),i=setTimeout(()=>{r.disconnect(),this.#V(Array.from(e.children)).then(t)},0)},r=new MutationObserver(e=>{e.some(e=>"childList"===e.type)&&s()});r.observe(e,{childList:!0}),s()})))}#W(e){return null==e?"":!0===e?"true":!1===e?"false":"number"==typeof e?String(e):"object"==typeof e?JSON.stringify(e):String(e)}#_(e){if(!e.startsWith(":")||"::app"===e)return;let t=e.replace(/^:+/,""),i=this.getAttribute(e),s=Object.getOwnPropertyDescriptor(this,t),r=i;if(!i&&s&&(s.get||void 0!==s.value)){let i=this[t],n=this.#W(i);this.getAttribute(e)!==n&&this.setAttribute(e,n),r=i,s=null}if(!(s&&void 0===s.set&&!1===s.writable||s&&void 0!==s.get&&void 0===s.set)){if(i)if("true"===i)r=!0;else if("false"===i)r=!1;else if(/^-?\d+(\.\d+)?$/.test(i))r=Number(i);else try{r=JSON.parse(i)}catch{r=i}if(s&&s.set)this[t]=r;else{let i=r;"object"==typeof r&&null!==r?i=this.#N(r,[t]):"function"==typeof r&&(i=this.#k(r,t));let s=e;if(Object.defineProperty(this,t,{get(){return this.#A(t),i},set(e){if(i!==e){i="object"==typeof e&&null!==e?this.#N(e,[t]):e,this.#w(t);let r=this.#W(e);this.getAttribute(s)!==r&&this.setAttribute(s,r)}},enumerable:!0,configurable:!0}),"object"==typeof r&&null!==r){let i=this.watch(t,()=>{let i=this[t],s=this.#W(i);this.getAttribute(e)!==s&&this.setAttribute(e,s)},{deep:!0});this.#c.push({type:"attrSync",unwatch:i})}}}}static get observedAttributes(){return[]}attributeChangedCallback(e,t,i){e.startsWith(":")&&"::app"!==e&&t!==i&&!0===this.#i&&this.#_(e)}connectedCallback(){this.#s(),Promise.all([new Promise(e=>{if(!0===this.#i)return e();this.#i=e}),new Promise(e=>{let t=null,i=()=>{clearTimeout(t),t=setTimeout(()=>{s.disconnect(),this.#V(Array.from(this.children)).then(e)},0)},s=new MutationObserver(e=>{e.some(e=>"childList"===e.type)&&i()});s.observe(this,{childList:!0}),i()})]).then(()=>{this.dispatch("setup");for(let e of this.attrs.keys())e.startsWith(":")&&"::app"!==e&&this.#_(e);if(!this.#n){if(this.childNodes.length>0){Array.from(this.childNodes).some(e=>e.nodeType===Node.ELEMENT_NODE||e.nodeType===Node.TEXT_NODE&&""!==e.textContent.trim())&&(this.#r=this.innerHTML,this.innerHTML="")}if(this.#r){let e=document.createElement("template");e.innerHTML=this.#r.trim();let t=e.content.cloneNode(!0);Array.from(t.childNodes).forEach(e=>this.#$(e)),this.appendChild(t),this.#n=!0,this.dispatch("rendered")}}!0!==this.#i||this.#p||(this.#p=new MutationObserver(e=>{for(let t of e)"attributes"===t.type&&t.attributeName&&t.attributeName.startsWith(":")&&"::app"!==t.attributeName&&this.#_(t.attributeName)}),this.#p.observe(this,{attributes:!0}))})}disconnectedCallback(){this.#p&&(this.#p.disconnect(),this.#p=null),this.#y(this.#c),this.#c=[];for(let e of this.#f)"getter"===e.type&&e.effect&&(this.#l.forEach((t,i)=>{t.delete(e.effect),0===t.size&&this.#l.delete(i)}),this.#a.delete(e.effect));this.#f=[],this.#g.forEach((e,t)=>{this[t]=e.original}),this.#g.clear(),this.#b.clear(),this.#l.clear(),this.#a.clear(),App.#t.delete(this)}toggleAttribute(e,t="",i=""){let s=this.getAttribute(e);this[""==t&&""==i&&(s||this.hasAttribute(e))?"removeAttribute":"setAttribute"](e,s!=t?t:i)}}